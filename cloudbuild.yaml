steps:
  - name: gcr.io/cloud-builders/docker
    id: Build Image
    entrypoint: 'bash'
    args: [ '-c', 'docker build -t $_IMAGE:$COMMIT_SHA -t $_IMAGE:latest --build-arg EMAIL_API_KEY="$$EMAIL_API_KEY" --build-arg EMAIL_SENDER_NAME="$$EMAIL_SENDER_NAME" --build-arg EMAIL_SENDER_ADDRESS="$$EMAIL_SENDER_ADDRESS" --build-arg EMAIL_RECIPIENT_NAME="$$EMAIL_RECIPIENT_NAME" --build-arg EMAIL_RECIPIENT_ADDRESS="$$EMAIL_RECIPIENT_ADDRESS" --build-arg SECURITY_ADMIN_UID="$$SECURITY_ADMIN_UID" --build-arg SECURITY_ADMIN_USERNAME="$$SECURITY_ADMIN_USERNAME" .' ]
    secretEnv: [ 'EMAIL_API_KEY', 'EMAIL_SENDER_NAME', 'EMAIL_SENDER_ADDRESS', 'EMAIL_RECIPIENT_NAME', 'EMAIL_RECIPIENT_ADDRESS', 'SECURITY_ADMIN_UID', 'SECURITY_ADMIN_USERNAME' ]
  - name: gcr.io/cloud-builders/docker
    id: Push Image
    args: [ push, '$_IMAGE:$COMMIT_SHA' ]
  - name: gcr.io/cloud-builders/gke-deploy
    id: Prepare GKE deployment
    args:
      - prepare
      - '--filename=$_K8S_PATH'
      - '--image=$_IMAGE:$COMMIT_SHA'
      - '--app=$_APP'
      - '--version=$COMMIT_SHA'
      - '--namespace=$_NAMESPACE'
      - '--annotation=$_K8S_ANNOTATIONS,gcb-build-id=$BUILD_ID'
      - '--create-application-cr'
      - '--output=output'
  - name: gcr.io/cloud-builders/gke-deploy
    id: Apply GKE deployment
    args:
      - apply
      - '--filename=output/expanded'
      - '--cluster=$_CLUSTER'
      - '--location=$_REGION'
      - '--namespace=$_NAMESPACE'
images:
  - '$_IMAGE:$COMMIT_SHA'
options:
  substitutionOption: ALLOW_LOOSE
substitutions:
  _IMAGE: gcr.io/warrenburg-portfolio/portfolio-server
  _K8S_PATH: kubernetes/
  _APP: portfolio-server
  _REGION: us-central1
  _NAMESPACE: portfolio
  _CLUSTER: portfolio
  _OUTPUT_BUCKET_PATH: warrenburg-portfolio_cloudbuild/deploy
availableSecrets:
  secretManager:
    - versionName: projects/warrenburg-portfolio/secrets/EMAIL_API_KEY/versions/latest
      env: EMAIL_API_KEY
    - versionName: projects/warrenburg-portfolio/secrets/EMAIL_SENDER_NAME/versions/latest
      env: EMAIL_SENDER_NAME
    - versionName: projects/warrenburg-portfolio/secrets/EMAIL_SENDER_ADDRESS/versions/latest
      env: EMAIL_SENDER_ADDRESS
    - versionName: projects/warrenburg-portfolio/secrets/EMAIL_RECIPIENT_NAME/versions/latest
      env: EMAIL_RECIPIENT_NAME
    - versionName: projects/warrenburg-portfolio/secrets/EMAIL_RECIPIENT_ADDRESS/versions/latest
      env: EMAIL_RECIPIENT_ADDRESS
    - versionName: projects/warrenburg-portfolio/secrets/SECURITY_ADMIN_UID/versions/latest
      env: SECURITY_ADMIN_UID
    - versionName: projects/warrenburg-portfolio/secrets/SECURITY_ADMIN_USERNAME/versions/latest
      env: SECURITY_ADMIN_USERNAME
